{
  "name": "AI Assistant",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/ai/ask",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "ai-ask"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'employees', (SELECT json_agg(json_build_object(\n    'id', e.id,\n    'name', CONCAT(e.first_name, ' ', e.last_name),\n    'restaurant', r.name,\n    'is_mobile', e.is_mobile,\n    'positions', e.positions,\n    'active', e.active,\n    'employment_type', COALESCE(e.employment_type, 'full_time'),\n    'fixed_day_off', e.fixed_day_off,\n    'max_hours_per_week', e.max_hours_per_week\n  )) FROM employees e LEFT JOIN restaurants r ON e.restaurant_id = r.id WHERE e.active = true),\n  'restaurants', (SELECT json_agg(json_build_object('id', id, 'name', name, 'location', location)) FROM restaurants),\n  'rules', (SELECT json_object_agg(key, value) FROM shift_rules)\n) as context;",
        "options": {}
      },
      "id": "get-context",
      "name": "Get Context",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [480, 300],
      "credentials": {
        "postgres": {
          "id": "GvtIl9xYacgDPoso",
          "name": "Planning PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const webhookData = $('Webhook Trigger').first().json;\nconst dbContext = $input.first().json.context;\nconst question = webhookData.body?.question || 'No question provided';\n\nconst employees = dbContext?.employees || [];\nconst restaurants = dbContext?.restaurants || [];\nconst rules = dbContext?.rules || {};\n\nconst DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\nconst TYPE_LABELS = { full_time: 'FT', part_time: 'PT', extra: 'EX' };\n\nconst employeeList = employees.map(e => {\n  const type = TYPE_LABELS[e.employment_type] || 'FT';\n  const dayOff = e.fixed_day_off !== null ? `Off:${DAYS[e.fixed_day_off]}` : '';\n  const maxHrs = e.max_hours_per_week ? `Max:${e.max_hours_per_week}h/w` : '';\n  const extras = [e.is_mobile ? 'Mobile' : '', dayOff, maxHrs].filter(Boolean).join(', ');\n  return `- ${e.name} (ID:${e.id}, ${type}, ${e.restaurant || 'Unassigned'}, ${(e.positions || []).join('/')}${extras ? ', ' + extras : ''})`;\n}).join('\\n');\n\nconst restaurantList = restaurants.map(r => `- ${r.name} (ID: ${r.id}): ${r.location}`).join('\\n');\n\n// Build rules section from database\nconst maxShift = rules.max_shift_hours || '8';\nconst minBreakThreshold = rules.min_break_threshold || '5';\nconst minBreakDuration = rules.min_break_duration || '30';\nconst minRest = rules.min_rest_between_shifts || '11';\nconst minEmployees = rules.min_employees_per_day || '3';\nconst maxWeeklyHours = rules.max_hours_per_week || '40';\nconst maxMissions = rules.max_missions_per_month || '2';\nconst minMissionDays = rules.min_mission_days || '2';\n\nconst systemPrompt = `You are Kruce, the scheduling assistant for Krooster (Kosmo Kompany). Be concise and direct.\n\nRESTAURANTS:\n${restaurantList}\n\nSHIFT SYSTEM:\n- TWO shifts per day: MORNING (10:00-18:00) and AFTERNOON (15:00-23:00)\n- Each shift is 8 hours with a 30-minute break\n- Employees work ONE shift per day maximum (never both)\n- Morning break at 14:00, afternoon break at 19:00\n\nEMPLOYEES (${employees.length}):\nLegend: FT=Full-time, PT=Part-time, EX=Extra (on-call)\n${employeeList || 'None'}\n\nEMPLOYMENT TYPES:\n- Full-time (FT): Regular staff, scheduled normally\n- Part-time (PT): Limited hours per week (check max_hours_per_week)\n- Extra (EX): On-call staff, only schedule when needed or understaffed\n\nFIXED DAYS OFF:\n- Some employees have a fixed day off each week (shown as Off:Mon, Off:Tue, etc.)\n- NEVER schedule them on their fixed day off unless they explicitly request it\n\nSCHEDULING RULES:\n- Max shift: ${maxShift}h/day\n- Break: ${minBreakDuration}min required for shifts >${minBreakThreshold}h\n- Rest between shifts: ${minRest}h minimum\n- Min employees/day: ${minEmployees} per restaurant\n- Max hours/week: ${maxWeeklyHours}h (respect individual limits for part-time)\n- Max missions/month: ${maxMissions} (min ${minMissionDays} consecutive days)\n\nACTIONS - Execute immediately when requested:\n\n1. ADD EMPLOYEE:\n\\`\\`\\`action\n{\"type\": \"add_employee\", \"data\": {\"first_name\": \"X\", \"last_name\": \"Y\", \"restaurant_id\": 1, \"is_mobile\": false, \"positions\": [\"service\"], \"employment_type\": \"full_time\", \"fixed_day_off\": null, \"max_hours_per_week\": null}}\n\\`\\`\\`\n- restaurant_id: 1=A la mer (Hua Hin), 2=Kosmo (Bangkok)\n- positions: kitchen, service, bar, steward, cashier, runner, security, manager\n- employment_type: full_time, part_time, extra\n- fixed_day_off: 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri, 5=Sat, 6=Sun, or null\n- max_hours_per_week: number or null (mainly for part_time)\n\n2. REMOVE EMPLOYEE:\n\\`\\`\\`action\n{\"type\": \"remove_employee\", \"data\": {\"id\": X}}\n\\`\\`\\`\n\nBEHAVIOR:\n- Respect fixed days off when suggesting schedules\n- Don't over-schedule part-time employees\n- Use extras only when regular staff is insufficient\n- If info is missing, ask briefly\n- Execute actions immediately - no confirmation needed\n- Keep responses short\n- Match user language`;\n\nreturn {systemPrompt, question, employeeCount: employees.length};"
      },
      "id": "prepare-prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [720, 300]
    },
    {
      "parameters": {
        "modelId": {"__rl": true, "mode": "list", "value": "llama-3.3-70b"},
        "messages": {
          "values": [
            {"role": "system", "content": "={{ $json.systemPrompt }}"},
            {"role": "user", "content": "={{ $json.question }}"}
          ]
        },
        "options": {"maxTokens": 2048, "temperature": 0.7}
      },
      "id": "call-cerebras",
      "name": "Call Cerebras",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [960, 300],
      "credentials": {
        "openAiApi": {"id": "KmYMJqpoHOBmdlVC", "name": "Cerebras"}
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst originalQuestion = $('Prepare Prompt').first().json.question;\nlet aiContent = response?.message?.content || response?.choices?.[0]?.message?.content || response?.content || 'Sorry, I could not generate a response.';\n\n// Parse any action commands from the response\nlet action = null;\nconst actionMatch = aiContent.match(/```action\\s*([\\s\\S]*?)```/);\nif (actionMatch) {\n  try {\n    action = JSON.parse(actionMatch[1].trim());\n  } catch (e) {\n    // Invalid JSON, ignore\n  }\n}\n\nreturn {\n  success: true,\n  question: originalQuestion,\n  response: aiContent,\n  action: action,\n  model: response?.model || 'llama-3.3-70b',\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1440, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[{"node": "Get Context", "type": "main", "index": 0}]]
    },
    "Get Context": {
      "main": [[{"node": "Prepare Prompt", "type": "main", "index": 0}]]
    },
    "Prepare Prompt": {
      "main": [[{"node": "Call Cerebras", "type": "main", "index": 0}]]
    },
    "Call Cerebras": {
      "main": [[{"node": "Format Response", "type": "main", "index": 0}]]
    },
    "Format Response": {
      "main": [[{"node": "Respond to Webhook", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"},
  "triggerCount": 1,
  "active": true
}
