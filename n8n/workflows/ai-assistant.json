{
  "name": "AI Assistant",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/ai/ask",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "ai-ask"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT json_build_object(\n  'employees', (SELECT json_agg(json_build_object(\n    'id', e.id,\n    'name', CONCAT(e.first_name, ' ', e.last_name),\n    'restaurant', r.name,\n    'is_mobile', e.is_mobile,\n    'positions', e.positions,\n    'active', e.active,\n    'employment_type', COALESCE(e.employment_type, 'full_time'),\n    'days_off', e.days_off,\n    'preferred_shift', e.preferred_shift,\n    'max_hours_per_week', e.max_hours_per_week\n  )) FROM employees e LEFT JOIN restaurants r ON e.restaurant_id = r.id WHERE e.active = true),\n  'restaurants', (SELECT json_agg(json_build_object('id', id, 'name', name, 'location', location, 'opening_hours', opening_hours, 'closing_hours', closing_hours)) FROM restaurants),\n  'rules', (SELECT json_object_agg(key, value) FROM shift_rules),\n  'total_shifts', (SELECT COUNT(*) FROM shifts),\n  'upcoming_missions', (SELECT json_agg(json_build_object('employee', CONCAT(e.first_name, ' ', e.last_name), 'destination', r.name, 'start', m.start_date, 'end', m.end_date, 'status', m.status)) FROM missions m JOIN employees e ON m.employee_id = e.id JOIN restaurants r ON m.destination_restaurant_id = r.id WHERE m.status IN ('proposed', 'accepted'))\n) as context;",
        "options": {}
      },
      "id": "get-context",
      "name": "Get Context",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [480, 300],
      "credentials": {
        "postgres": {
          "id": "9VNgnYivXVttuYb7",
          "name": "PostgreSQL Planning"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const webhookData = $('Webhook Trigger').first().json;\nconst dbContext = $input.first().json.context;\nconst question = webhookData.body?.question || 'No question provided';\n\nconst employees = dbContext?.employees || [];\nconst restaurants = dbContext?.restaurants || [];\nconst rules = dbContext?.rules || {};\nconst totalShifts = dbContext?.total_shifts || 0;\nconst upcomingMissions = dbContext?.upcoming_missions || [];\n\nconst DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];\nconst TYPE_LABELS = { full_time: 'FT', part_time: 'PT', extra: 'EX' };\nconst SHIFT_LABELS = { morning: 'AM', afternoon: 'PM', flexible: 'Flex' };\n\nconst employeeList = employees.map(e => {\n  const type = TYPE_LABELS[e.employment_type] || 'FT';\n  const shift = SHIFT_LABELS[e.preferred_shift] || '';\n  const daysOff = e.days_off?.length ? `Off:${e.days_off.map(d => DAYS[d]).join(',')}` : '';\n  const maxHrs = e.max_hours_per_week ? `Max:${e.max_hours_per_week}h/w` : '';\n  const extras = [e.is_mobile ? 'Mobile' : '', shift, daysOff, maxHrs].filter(Boolean).join(', ');\n  return `- ${e.name} (ID:${e.id}, ${type}, ${e.restaurant || 'Unassigned'}, ${(e.positions || []).join('/')}${extras ? ', ' + extras : ''})`;\n}).join('\\n');\n\nconst restaurantList = restaurants.map(r => `- ${r.name} (ID:${r.id}): ${r.location}, Hours: ${r.opening_hours}-${r.closing_hours}`).join('\\n');\n\nconst missionList = upcomingMissions?.length ? upcomingMissions.map(m => `- ${m.employee} -> ${m.destination} (${m.start} to ${m.end}) [${m.status}]`).join('\\n') : 'None';\n\nconst systemPrompt = `You are Kruce, the scheduling assistant for Krooster (Kosmo Kompany restaurants). Be concise and helpful.\n\nRESTAURANTS:\n${restaurantList}\n\nSHIFT SYSTEM:\n- TWO shifts per day: MORNING and AFTERNOON\n- A la mer (Hua Hin): 11:00-23:00, closed Jan 1st\n- Kosmo (Bangkok): 10:30-00:30, open every day\n- Employees have shift preferences (AM/PM/Flexible)\n\nEMPLOYEES (${employees.length} active):\nLegend: FT=Full-time, PT=Part-time, EX=Extra, AM=Morning pref, PM=Afternoon pref\n${employeeList || 'None'}\n\nUPCOMING MISSIONS:\n${missionList}\n\nSTATS:\n- Total shifts in system: ${totalShifts}\n\nEMPLOYMENT TYPES:\n- Full-time (FT): Regular staff, ~48h/week\n- Part-time (PT): Limited hours (check max_hours_per_week)\n- Extra (EX): On-call, schedule only when needed\n\nDAYS OFF:\n- Employees can have fixed days off (Off:Mon, Off:Tue,Wed, etc.)\n- NEVER schedule them on their days off\n- Days: 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri, 5=Sat, 6=Sun\n\nMISSIONS:\n- Mobile employees can be sent to the other restaurant\n- Missions include accommodation\n- When on mission, employee works at destination restaurant\n\nRULES:\n- Max shift: ${rules.max_shift_hours || 8}h\n- Min break: ${rules.min_break_duration || 30}min for shifts >${rules.min_break_threshold || 5}h\n- Min rest between shifts: ${rules.min_rest_between_shifts || 11}h\n- Min employees/day: ${rules.min_employees_per_day || 3}\n- Max hours/week: ${rules.max_hours_per_week || 48}h\n\nBEHAVIOR:\n- Answer questions about employees, schedules, restaurants\n- Help with scheduling decisions\n- Respect days off and shift preferences\n- Be concise and direct\n- Match user's language (English/French/Thai)`;\n\nreturn {systemPrompt, question, employeeCount: employees.length};"
      },
      "id": "prepare-prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [720, 300]
    },
    {
      "parameters": {
        "modelId": {"__rl": true, "mode": "list", "value": "llama-3.3-70b"},
        "messages": {
          "values": [
            {"role": "system", "content": "={{ $json.systemPrompt }}"},
            {"role": "user", "content": "={{ $json.question }}"}
          ]
        },
        "options": {"maxTokens": 2048, "temperature": 0.7, "baseURL": "https://api.cerebras.ai/v1"}
      },
      "id": "call-cerebras",
      "name": "Call Cerebras",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [960, 300],
      "credentials": {
        "openAiApi": {"id": "atGx0kh8PfIttF1y", "name": "Cerebras"}
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst originalQuestion = $('Prepare Prompt').first().json.question;\nlet aiContent = response?.message?.content || response?.choices?.[0]?.message?.content || response?.content || response?.text || 'Sorry, I could not generate a response.';\n\nreturn {\n  success: true,\n  question: originalQuestion,\n  response: aiContent,\n  model: response?.model || 'llama-3.3-70b',\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1440, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[{"node": "Get Context", "type": "main", "index": 0}]]
    },
    "Get Context": {
      "main": [[{"node": "Prepare Prompt", "type": "main", "index": 0}]]
    },
    "Prepare Prompt": {
      "main": [[{"node": "Call Cerebras", "type": "main", "index": 0}]]
    },
    "Call Cerebras": {
      "main": [[{"node": "Format Response", "type": "main", "index": 0}]]
    },
    "Format Response": {
      "main": [[{"node": "Respond to Webhook", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"},
  "triggerCount": 1,
  "active": true
}
